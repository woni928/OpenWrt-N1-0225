name: åªæ‰“åŒ…

on:
  workflow_dispatch:
   inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  #schedule:
    #- cron: "0 0 1 * *"

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: N1/immortalwrt/TL.config
  DIY_SH: N1/immortalwrt/TL-diy.sh
  FILES: N1/files
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@main

    - name: æ‰“åŒ…é•œåƒæ–‡ä»¶
      if: ${{ env.compile_status }} == 'success' && !cancelled()
      uses: unifreq/openwrt_packit@master
      env:
        OPENWRT_ARMVIRT: https://github.com/ham0223/OpenWrt-N1/releases/download/N1-0407_20250303/openwrt-armvirt-64-generic-rootfs.tar.gz
        KERNEL_VERSION_NAME: 6.6.y
        PACKAGE_SOC: s905d
        GZIP_IMGS: .xz
        #SCRIPT_DIY_PATH: N1/immortalwrt/mk_s905d_n1.sh
        WHOAMI: ham
        OPENWRT_VER: $(date +"%Y.%m.%d")
        SW_FLOWOFFLOAD: 0
        SFE_FLOW: 0
        ENABLE_WIFI_K510: 0

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      if: ${{ env.PACKAGED_STATUS == 'success' }} && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H.%M")" >> ${GITHUB_OUTPUT}
        touch release.txt
        echo "
        ğŸ æ³¨æ„äº‹é¡¹ï¼šé¦–æ¬¡ä½¿ç”¨å»ºè®®å…¨æ–°åˆ·å†™
        ğŸ’» é€‚ç”¨æœºå‹: æ–è®¯N1
        ğŸ“‚ æºç : ${{ env.REPO_URL }}
        ğŸŒ³ åˆ†æ”¯: ${{ env.REPO_BRANCH }}
        â±ï¸ ç¼–è¯‘æ—¶é—´: $(date +"%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†")
        ğŸŒ ç®¡ç†åœ°å€: 192.168.123.2
        ğŸ‘¤ ç”¨æˆ·å: root
        ğŸ”’ å¯†ç : password 
        
        æ›´æ–°æ—¥å¿—ï¼š
        2025-0310ï¼šæµ‹è¯•æ‰“åŒ…æµç¨‹ã€‚
        
        " >> release.txt
        echo "tag_status=success" >> $GITHUB_ENV

    - name: å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v2
      if: ${{ env.tag_status == 'success' }} && !cancelled()
      with:
        tag_name: OpenWrt_${{ env.PACKAGED_OUTPUTDATE }}
        files: ${{ env.PACKAGED_OUTPUTPATH }}/*.img.xz
        body_path: release.txt
        token: ${{ env.GITHUB_TOKEN }}

    - name: åˆ é™¤è¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 3
        keep_minimum_runs: 5
        token: ${{ env.GITHUB_TOKEN }}

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 7
        delete_tags : true
